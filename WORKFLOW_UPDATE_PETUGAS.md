# ğŸ“‹ Workflow Peminjaman - Update dengan Persetujuan Petugas

## ğŸ”„ Workflow Lengkap (Updated)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User Daftar & Pinjam Buku         â”‚
â”‚   Status: PENDING                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Petugas Lihat di Dashboard        â”‚
â”‚   Tabel: "Peminjaman Menunggu       â”‚
â”‚   Persetujuan Anda"                 â”‚
â”‚                                     â”‚
â”‚   Aksi: Setujui / Tolak             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SETUJUI   â”‚   â”‚  TOLAK     â”‚
â”‚ Status:   â”‚   â”‚ Hapus      â”‚
â”‚ PENDING_  â”‚   â”‚ Record     â”‚
â”‚ PETUGAS   â”‚   â”‚ Notifikasi â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Diteruskan ke Admin               â”‚
â”‚   Admin Lihat di Dashboard          â”‚
â”‚                                     â”‚
â”‚   Aksi: Setujui / Tolak             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SETUJUI   â”‚   â”‚   TOLAK      â”‚
â”‚ Status:   â”‚   â”‚ Hapus Record â”‚
â”‚ ACTIVE    â”‚   â”‚ Notifikasi   â”‚
â”‚ Stok -1   â”‚   â”‚              â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Petugas Konfirmasi Pengambilan    â”‚
â”‚   User Mengambil Buku               â”‚
â”‚   confirmed_at diisi                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User Mengembalikan Buku           â”‚
â”‚   Petugas Verifikasi Pengembalian   â”‚
â”‚                                     â”‚
â”‚   Status: RETURNED                  â”‚
â”‚   returned_at diisi                 â”‚
â”‚   Stok +1                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Status Peminjaman

| Status | Deskripsi | Peran | Aksi |
|--------|-----------|-------|------|
| `pending` | Menunggu persetujuan petugas | Petugas | âœ… Setujui / âŒ Tolak |
| `pending_petugas` | Menunggu persetujuan admin (setelah petugas setuju) | Admin | âœ… Setujui / âŒ Tolak |
| `active` | Telah disetujui, user bisa ambil | Petugas | ğŸ“‹ Konfirmasi pengambilan |
| `returned` | Buku sudah dikembalikan | - | âœ… Selesai |
| `overdue` | Melewati batas waktu | Petugas | ğŸ“‹ Verifikasi pengembalian |

---

## ğŸ¯ Dashboard Petugas - Tabel Baru

### "Peminjaman Menunggu Persetujuan Anda"

**Tampilan**: Tabel dengan kolom:
- User (Nama + Email)
- Buku (Judul + Penulis)
- Durasi (Badge)
- Tanggal Pinjam
- Aksi (Lihat, Setujui, Tolak)

**Data Ditampilkan**:
- Max 10 peminjaman status "pending"
- Order by created_at (paling lama terlebih dahulu)
- Live count: "X Menunggu" (badge)

**Kondisi Kosong**:
- Menampilkan: "Tidak ada peminjaman yang menunggu persetujuan" âœ…

---

## ğŸ” Aksi Petugas di Dashboard

### 1. **Setujui Peminjaman** âœ…
**Route**: `POST /petugas/borrowings/{id}/approve-pending`

**Kondisi**: Status = "pending"

**Proses**:
```php
$borrowing->update(['status' => 'pending_petugas']);
// Notifikasi ke user: "Peminjaman Disetujui Petugas"
```

**Hasil**:
- Status berubah: `pending` â†’ `pending_petugas`
- User menerima notifikasi
- Diteruskan ke admin untuk persetujuan akhir

---

### 2. **Tolak Peminjaman** âŒ
**Route**: `POST /petugas/borrowings/{id}/reject-pending`

**Kondisi**: Status = "pending"

**Proses**:
```php
$borrowing->delete();
// Notifikasi ke user: "Peminjaman Ditolak"
```

**Hasil**:
- Record dihapus dari database
- User menerima notifikasi penolakan
- Peminjaman selesai (tidak dilanjutkan ke admin)

---

## ğŸ“‚ File-File yang Diupdate

### Controllers
```php
// Petugas/BorrowingController.php
- approvePending($borrowing)      // Status pending â†’ pending_petugas
- rejectPending($borrowing)       // Hapus record
- confirm($borrowing)             // Konfirmasi pengambilan
- verifyReturn($borrowing)        // Verifikasi pengembalian
```

```php
// Petugas/DashboardController.php
- index()                         // Load pending_approvals
```

### Views
```blade
// petugas/dashboard.blade.php
+ Tabel "Peminjaman Menunggu Persetujuan Anda"

// petugas/borrowings/index.blade.php
+ Status badge: "pending_petugas"
+ Tombol: Setujui, Tolak (untuk status pending)
```

### Routes
```php
Route::post('/{borrowing}/approve-pending', 'approvePending')
    ->name('petugas.borrowings.approve-pending');
Route::post('/{borrowing}/reject-pending', 'rejectPending')
    ->name('petugas.borrowings.reject-pending');
```

### Database
```sql
-- Status enum updated
ALTER TABLE borrowings 
MODIFY COLUMN status ENUM(
    'pending', 
    'pending_petugas',  -- NEW
    'active', 
    'returned', 
    'overdue'
);
```

---

## ğŸ¨ UI Changes

### Dashboard
- **Tabel Baru**: "Peminjaman Menunggu Persetujuan Anda"
- **Tombol**: Lihat, Setujui (hijau), Tolak (merah)
- **Badge**: "X Menunggu" (warning)

### Borrowing List (Daftar Peminjaman)
- **Status Badge Baru**: `pending_petugas` (info/biru)
- **Tombol Kontekstual**:
  - Pending: Setujui (thumb up) + Tolak (times)
  - Pending_Petugas: View only (waiting admin)
  - Active: Konfirmasi pengambilan
  - Active + Confirmed: Verifikasi pengembalian

---

## ğŸ“ Error Fixes

âœ… **Fixed**: `Call to a member function format() on null`
- Added null safety checks di view:
  ```blade
  {{ $borrowing->borrow_date ? $borrowing->borrow_date->format('d/m/Y') : '-' }}
  {{ $borrowing->duration_days ?? '-' }}
  ```

---

## ğŸ”— Migration Files

1. `2026_01_25_000003_add_pending_petugas_status_to_borrowings.php`
   - Adds new enum value `pending_petugas` to status column

---

## ğŸš€ Testing Checklist

- [ ] Login sebagai petugas
- [ ] Dashboard muncul tabel "Peminjaman Menunggu Persetujuan"
- [ ] Klik "Setujui" â†’ Status berubah ke pending_petugas
- [ ] Klik "Tolak" â†’ Record dihapus, notifikasi terkirim
- [ ] User menerima notifikasi "Disetujui Petugas"
- [ ] Admin melihat peminjaman status pending_petugas di dashboard
- [ ] Responsive di mobile

---

## ğŸ’¡ Key Points

âœ… Petugas adalah **gatekeeper pertama** (pre-approval)  
âœ… Admin adalah **approval akhir** sebelum buku diambil  
âœ… Dual-approval system menambah kontrol kualitas  
âœ… Petugas bisa tolak tanpa melibatkan admin  
âœ… Semua aksi menghasilkan notifikasi ke user  
âœ… Null safety checks mencegah error format()  

---

## ğŸ“Š New Status Flow Summary

**Petugas Persetujuan** â†’ **Admin Persetujuan** â†’ **Pengambilan** â†’ **Pengembalian**

`pending` â†’ `pending_petugas` â†’ `active` â†’ `returned`

Petugas memiliki **decision power** di tahap awal! ğŸ¯
